---
- name: Snap maintenance start
  debug:
    msg: "Starting Snap maintenance"

- name: Refresh Snap packages
  command: snap refresh
  register: snap_refresh
  changed_when: "'All snaps up to date' not in snap_refresh.stdout"

- name: Show snap refresh status
  debug:
    msg: "{{ snap_refresh.stdout_lines }}"
  when: snap_refresh.changed

- name: Get list of disabled snaps
  shell: snap list --all | awk '/disabled/{print $1, $3}'
  register: snap_disabled
  changed_when: false
  failed_when: false

- name: Remove disabled snaps
  command: snap remove "{{ item.split()[0] }}" --revision="{{ item.split()[1] }}"
  loop: "{{ snap_disabled.stdout_lines }}"
  when: snap_disabled.stdout_lines | length > 0
  register: snap_cleanup
  failed_when: false

- name: Snap maintenance complete
  debug:
    msg: "Snap maintenance completed"